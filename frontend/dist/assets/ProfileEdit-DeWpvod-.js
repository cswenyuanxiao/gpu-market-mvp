import{j as t}from"./react-query-BGeIQRPr.js";import{r as o}from"./react-CTDr35rJ.js";import{u as g,a as c}from"./index-BFCOulkZ.js";import{F as E}from"./FormField-iyrhpl26.js";import{A as S,I as b,B as A}from"./antd-C_PMe3Fi.js";function _(){const[s,m]=o.useState(""),[F,u]=o.useState(""),[h,f]=o.useState(null),[p,d]=o.useState(null),[y,v]=o.useState(!1),{login:w}=g();o.useEffect(()=>{localStorage.getItem("token")&&c("/api/users/me").then(async e=>{const a=await e.json();m(a.display_name||""),u(a.display_name||""),d(a.avatar_path||null)}).catch(()=>{})},[]);function x(n){var a;const e=((a=n.target.files)==null?void 0:a.item(0))||null;f(e),e&&d(URL.createObjectURL(e))}async function j(n){var e,a;n.preventDefault(),v(!0);try{if((s||"").trim().length>0){const r=await c("/api/users/me",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({display_name:s.trim()})});if(!r.ok){const l=((e=await r.json().catch(()=>({})))==null?void 0:e.error)||"Update failed";window.dispatchEvent(new CustomEvent("app-toast",{detail:{text:l,type:"error"}}));return}const i=await r.json().catch(()=>({}));i!=null&&i.token&&w(i.token),window.dispatchEvent(new CustomEvent("app-toast",{detail:{text:"Profile updated",type:"success"}})),u(s)}if(h){const r=new FormData;r.append("avatar",h);const i=await c("/api/users/me/avatar",{method:"POST",body:r});if(!i.ok){const l=((a=await i.json().catch(()=>({})))==null?void 0:a.error)||"Upload failed";window.dispatchEvent(new CustomEvent("app-toast",{detail:{text:l,type:"error"}}));return}window.dispatchEvent(new CustomEvent("app-toast",{detail:{text:"Avatar updated",type:"success"}}));try{const l=await(await c("/api/users/me")).json();d(l.avatar_path||null),f(null)}catch{}}}finally{v(!1)}}return t.jsxs("div",{className:"container py-3",style:{maxWidth:520},children:[t.jsx("h3",{children:"Edit Profile"}),t.jsxs("form",{onSubmit:j,children:[t.jsxs("div",{className:"d-flex align-items-center gap-3 mb-3",children:[t.jsx(S,{size:64,src:p||void 0,children:s==null?void 0:s[0]}),t.jsx(b,{value:s,onChange:n=>m(n.target.value),style:{maxWidth:260},placeholder:"Display name"})]}),t.jsx(E,{label:"Avatar",htmlFor:"avatar",children:t.jsx("input",{id:"avatar",type:"file",accept:"image/*",className:"form-control",onChange:x})}),p&&t.jsx("div",{className:"mb-3",children:t.jsx("img",{src:p,style:{width:96,height:96,objectFit:"cover"},className:"rounded"})}),t.jsx(A,{type:"primary",loading:y,htmlType:"submit",children:"Save"})]})]})}export{_ as default};
