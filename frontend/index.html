<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GPU Market</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">GPU Market</a>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="p-4 mb-4 bg-light rounded-3">
        <div class="container-fluid py-2">
          <h1 class="display-6">Find your next GPU</h1>
          <form id="heroForm" class="d-flex gap-2 mt-2">
            <input class="form-control form-control-lg" name="q" placeholder="Search GPUs...">
            <select class="form-select form-select-lg" id="sortSelect">
              <option value="newest">Newest</option>
              <option value="price_asc">Price ↑</option>
              <option value="price_desc">Price ↓</option>
            </select>
            <button class="btn btn-primary btn-lg" id="heroSearchBtn">Search</button>
            <button class="btn btn-outline-secondary btn-lg" id="myListingsBtn" type="button">My Listings</button>
          </form>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <h5>Search & Filters</h5>
          <form id="searchForm" class="mb-2">
            <div id="searchError" class="alert alert-danger d-none"></div>
            <input class="form-control mb-2" name="q" placeholder="Search title or description">
            <div class="d-flex gap-2 mb-2">
              <input class="form-control" name="min" placeholder="Min price">
              <input class="form-control" name="max" placeholder="Max price">
            </div>
            <div class="d-flex gap-2 mb-2">
              <select class="form-select" name="brand">
                <option value="">Any brand</option>
                <option>NVIDIA</option>
                <option>AMD</option>
              </select>
              <select class="form-select" name="vram">
                <option value="">Any VRAM</option>
                <option value="4">≥ 4GB</option>
                <option value="6">≥ 6GB</option>
                <option value="8">≥ 8GB</option>
                <option value="12">≥ 12GB</option>
                <option value="16">≥ 16GB</option>
              </select>
            </div>
            <select class="form-select mb-2" name="condition">
              <option value="">Any condition</option>
              <option>New</option>
              <option>Used</option>
            </select>
            <button class="btn btn-primary" id="searchBtn">Search</button>
          </form>

          <h5>Create listing</h5>
          <form id="createForm">
            <div id="createError" class="alert alert-danger d-none"></div>
            <input class="form-control mb-2" name="title" placeholder="Title" required>
            <input class="form-control mb-2" name="price" placeholder="Price" required>
            <select class="form-select mb-2" name="condition"><option>New</option><option>Used</option></select>
            <div class="d-flex gap-2 mb-2">
              <select class="form-select" name="brand">
                <option value="">Brand</option>
                <option>NVIDIA</option>
                <option>AMD</option>
              </select>
              <input class="form-control" name="vram_gb" placeholder="VRAM (GB)">
            </div>
            <textarea class="form-control mb-2" name="description" placeholder="Description"></textarea>
            <div class="mb-2">
              <div id="dropZone" class="border rounded p-3 text-center text-muted">Drag & drop image here or click to select</div>
              <input type="file" name="image" id="imageInput" class="form-control mt-2" accept="image/*" hidden>
              <img id="previewImg" class="img-fluid mt-2 d-none" alt="preview">
            </div>
            <button class="btn btn-success" type="submit">Create</button>
          </form>
        </div>

        <div class="col-md-8">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <button id="profileBtn" class="btn btn-outline-secondary">My Profile</button>
            </div>
            <div>
              <form id="authForm" class="d-inline">
                <div id="authError" class="alert alert-danger d-inline-block py-1 px-2 me-2 d-none"></div>
                <input class="form-control d-inline-block" style="width:150px" name="username" placeholder="Username">
                <input class="form-control d-inline-block" style="width:150px" name="password" type="password" placeholder="Password">
                <button class="btn btn-secondary" id="loginBtn">Login</button>
                <button class="btn btn-link" id="registerBtn">Register</button>
              </form>
            </div>
          </div>

          <div id="listings" class="row"></div>
          <nav class="mt-3" aria-label="pagination">
            <ul id="pagination" class="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- Edit modal (simple) -->
    <div class="modal" tabindex="-1" id="editModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Edit Listing</h5></div>
          <div class="modal-body">
            <form id="editForm">
              <input class="form-control mb-2" name="title">
              <input class="form-control mb-2" name="price">
              <select class="form-select mb-2" name="condition"><option>New</option><option>Used</option></select>
              <textarea class="form-control mb-2" name="description"></textarea>
              <input type="file" name="image" class="form-control mb-2" accept="image/*">
              <input type="hidden" name="id">
            </form>
          </div>
          <div class="modal-footer">
            <button id="saveEdit" class="btn btn-primary">Save</button>
            <button id="closeEdit" class="btn btn-secondary">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script>
    const API = 'http://localhost:3000';
    function getToken(){return localStorage.getItem('token');}
    function parseJwt(token){ try{const p = token.split('.')[1]; return JSON.parse(atob(p)); }catch(e){return null;} }

    let currentPage = 1, currentQuery = {};
    let myListingsMode = false;

    async function doSearch(params={}){
      currentQuery = {...currentQuery, ...params};
      const headers = {};
      const url = myListingsMode ? new URL(API + '/api/my/gpus') : new URL(API + '/api/search');
      if(!myListingsMode){
        url.search = new URLSearchParams({ ...currentQuery, page: currentPage }).toString();
      } else {
        const t=getToken(); if(t) headers['Authorization']='Bearer '+t;
      }
      const res = await fetch(url, { headers });
      const j = await res.json();
      const results = myListingsMode ? j : j.results;
      renderListings(results);
      if(!myListingsMode) renderPagination(j.total, j.page, j.per); else { document.getElementById('pagination').innerHTML=''; }
    }

    function renderListings(items){
      const container = document.getElementById('listings'); container.innerHTML='';
      const me = parseJwt(getToken());
      for(const gpu of items){
        const col = document.createElement('div'); col.className='col-md-6';
        col.innerHTML = `
          <div class="card mb-3">
            <div class="row g-0">
              ${gpu.image_path?`<div class="col-4"><img src="${API}${gpu.image_path}" class="img-fluid rounded-start" style="height:160px;object-fit:cover"></div>`:''}
              <div class="col"><div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="card-title mb-0">${gpu.title}</h5>
                  <span class="badge ${gpu.condition==='New'?'bg-success':'bg-secondary'}">${gpu.condition}</span>
                </div>
                <p class="card-text mt-2">${gpu.description||''}</p>
                <p class="card-text d-flex align-items-center gap-2"><small class="text-muted">£${gpu.price}</small>
                  ${gpu.seller_avatar?`<img src="${API}${gpu.seller_avatar}" class="rounded-circle" style="width:24px;height:24px;object-fit:cover">`:''}
                  <small class="text-muted">Seller: ${gpu.seller_name||''}</small>
                </p>
                ${me && me.id === gpu.seller_id ? `<button class="btn btn-sm btn-outline-primary me-2" data-editid="${gpu.id}">Edit</button><button class="btn btn-sm btn-outline-danger" data-delid="${gpu.id}">Delete</button>` : ''}
              </div></div>
            </div></div>`;
        container.appendChild(col);
      }
      document.querySelectorAll('[data-editid]').forEach(b=>b.addEventListener('click', openEdit));
      document.querySelectorAll('[data-delid]').forEach(b=>b.addEventListener('click', delListing));
    }

    function renderPagination(total, page, per){
      const ul = document.getElementById('pagination'); ul.innerHTML='';
      const pages = Math.ceil(total/per);
      for(let i=1;i<=pages;i++){
        const li = document.createElement('li'); li.className='page-item'+(i===page?' active':'');
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        if(i===page){ li.classList.add('disabled'); }
        li.addEventListener('click', (e)=>{ e.preventDefault(); if(i===page) return; currentPage=i; doSearch(); });
        ul.appendChild(li);
      }
    }

    async function openEdit(e){
      const id = e.currentTarget.dataset.editid;
      const res = await fetch(API + '/api/gpus/' + id); const j = await res.json();
      const form = document.getElementById('editForm'); form.title.value=j.title; form.price.value=j.price; form.condition.value=j.condition; form.description.value=j.description; form.id.value=j.id;
      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
      document.getElementById('saveEdit').onclick = async ()=>{
        const fd = new FormData(form);
        const token = getToken();
        const r = await fetch(API + '/api/gpus/' + id, { method:'PUT', headers: { 'Authorization':'Bearer '+token }, body: fd });
        if (r.ok){ modal.hide(); doSearch(); } else { alert('Failed'); }
      };
      document.getElementById('closeEdit').onclick = ()=> modal.hide();
    }

    async function delListing(e){
      if(!confirm('Delete?')) return; const id = e.currentTarget.dataset.delid; const token = getToken();
      const r = await fetch(API + '/api/gpus/' + id, { method:'DELETE', headers: { 'Authorization':'Bearer '+token } });
      if (r.ok) doSearch(); else alert('Delete failed');
    }

    document.getElementById('searchForm').addEventListener('submit', (e)=>{ e.preventDefault(); const data=Object.fromEntries(new FormData(e.target)); if(data.vram){ data.vram_min=data.vram; delete data.vram; } currentPage=1; myListingsMode=false; document.getElementById('searchError').classList.add('d-none'); doSearch(data).catch(err=>{ const el=document.getElementById('searchError'); el.textContent=err.message||'Search failed'; el.classList.remove('d-none'); }); });
    document.getElementById('heroForm').addEventListener('submit', (e)=>{ e.preventDefault(); const q=e.target.q.value; const sort=document.getElementById('sortSelect').value; currentPage=1; myListingsMode=false; doSearch({ q, sort }); });
    document.getElementById('sortSelect').addEventListener('change', ()=>{ const sort=document.getElementById('sortSelect').value; doSearch({ sort }); });
    document.getElementById('myListingsBtn').addEventListener('click', ()=>{ myListingsMode=true; doSearch({}); });

    document.getElementById('authForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const data=Object.fromEntries(new FormData(e.target)); const r=await fetch(API+'/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); const j=await r.json(); const errEl=document.getElementById('authError'); if(j.token){localStorage.setItem('token', j.token); errEl.classList.add('d-none'); alert('Logged in');} else { errEl.textContent=j.error||'Login failed'; errEl.classList.remove('d-none'); } });
    document.getElementById('registerBtn').addEventListener('click', async ()=>{ const u=prompt('username'); const p=prompt('password'); if(!u||!p) return; const r=await fetch(API+'/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u,password:p})}); if(r.status===201) alert('Registered'); else {const j=await r.json(); alert(j.error||'Failed');} });

    // Drag & drop + preview
    const dz=document.getElementById('dropZone'); const input=document.getElementById('imageInput'); const preview=document.getElementById('previewImg');
    dz.addEventListener('click', ()=> input.click());
    dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('bg-light'); });
    dz.addEventListener('dragleave', ()=> dz.classList.remove('bg-light'));
    dz.addEventListener('drop', e=>{ e.preventDefault(); dz.classList.remove('bg-light'); if(e.dataTransfer.files[0]) { input.files=e.dataTransfer.files; const f=e.dataTransfer.files[0]; const url=URL.createObjectURL(f); preview.src=url; preview.classList.remove('d-none'); }});
    input.addEventListener('change', e=>{ const f=e.target.files[0]; if(f){ const url=URL.createObjectURL(f); preview.src=url; preview.classList.remove('d-none'); }});

    document.getElementById('createForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const fd=new FormData(e.target); const token=getToken(); const errEl=document.getElementById('createError'); if(!token){ errEl.textContent='Please login first'; errEl.classList.remove('d-none'); return; } const r = await fetch(API+'/api/gpus',{ method:'POST', headers:{ 'Authorization':'Bearer '+token }, body:fd }); if(r.status===201){ e.target.reset(); errEl.classList.add('d-none'); preview.classList.add('d-none'); doSearch(); } else { const j=await r.json(); errEl.textContent=j.error||'Failed'; errEl.classList.remove('d-none'); }
    });

    document.getElementById('profileBtn').addEventListener('click', async ()=>{
      const token = getToken(); if(!token){alert('login first');return;} const me = parseJwt(token); window.location.hash = 'profile';
      const res = await fetch(API + '/api/users/' + me.id); const profile = await res.json();
      const html = `
        <div class="container mt-4">
          <h3>Profile: ${profile.display_name}</h3>
          <img src="${profile.avatar_path?API+profile.avatar_path:''}" style="max-width:120px" class="img-thumbnail mb-2">
          <div><input type="file" id="avatarInput"></div>
          <button id="uploadAvatar" class="btn btn-sm btn-primary mt-2">Upload avatar</button>
          <button id="backBtn" class="btn btn-sm btn-secondary mt-2">Back</button>
        </div>`;
      document.body.innerHTML = html;
      document.getElementById('backBtn').addEventListener('click', ()=> location.reload());
      document.getElementById('uploadAvatar').addEventListener('click', async ()=>{
        const f = document.getElementById('avatarInput').files[0]; if(!f){alert('Pick file');return;} const fd = new FormData(); fd.append('avatar', f);
        const r = await fetch(API + '/api/users/me/avatar', { method:'POST', headers: { 'Authorization':'Bearer '+token }, body: fd }); if(r.ok) alert('Uploaded'); else alert('Failed');
      });
    });

    // initial load
    doSearch({});
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14'>🎮</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
  </html>


